<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì¸ì²œ ë¡œì»¬ ë®¤ì§ ìŠ¤íŒŸ ì¶”ì²œ ê²Œì„</title>
  <style>
    :root{
      --bg:#f7f8fc; --card:#fff; --text:#111827; --muted:rgba(17,24,39,.65);
      --line:rgba(17,24,39,.12); --shadow:0 18px 45px rgba(0,0,0,.10);
      --accent:#3b82f6; --chip:#f1f5f9; --chip2:#eef2ff; --radius:18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(59,130,246,.16), transparent 60%),
        radial-gradient(1000px 600px at 80% 25%, rgba(236,72,153,.12), transparent 55%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:22px;
    }
    .wrap{ width:min(980px, 100%); display:grid; gap:14px; }
    header{ display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap; }
    h1{ margin:0; font-size:20px; letter-spacing:.2px; }
    .sub{ margin:0; color:var(--muted); font-size:13px; line-height:1.45; }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.98), rgba(255,255,255,.92));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .topbar{
      padding:14px;
      border-bottom:1px solid var(--line);
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .stamp{
      display:inline-flex; align-items:center; gap:10px;
      padding:9px 12px;
      border-radius:999px;
      border:1px dashed rgba(17,24,39,.22);
      background:rgba(255,255,255,.75);
      font-size:13px;
      width:max-content;
    }
    .stamp b{ font-weight:900; letter-spacing:.2px; }

    .content{ padding:14px; display:grid; gap:14px; }
    .controls{
      display:grid;
      gap:10px;
      background:rgba(255,255,255,.85);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:12px;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 760px){ .row{ grid-template-columns:1fr; } }

    .field{ display:grid; gap:6px; }
    label{ font-size:12px; color:var(--muted); }
    select{
      width:100%;
      border:1px solid var(--line);
      background:rgba(0,0,0,.02);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      outline:none;
    }

    button{
      appearance:none;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.95), rgba(17,24,39,.02));
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:850;
      transition:.15s transform, .15s background;
    }
    button:hover{ background:rgba(255,255,255,.9); }
    button:active{ transform:translateY(1px); }
    .primary{
      background:linear-gradient(180deg, rgba(59,130,246,.20), rgba(59,130,246,.06));
      border-color:rgba(59,130,246,.35);
    }
    .ghost{ background:rgba(17,24,39,.03); }
    .danger{
      background:linear-gradient(180deg, rgba(239,68,68,.16), rgba(239,68,68,.05));
      border-color:rgba(239,68,68,.28);
    }

    .activityBox{
      border:1px solid var(--line);
      background:#fff;
      border-radius:16px;
      padding:12px;
      display:grid;
      gap:10px;
    }
    .actTop{
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .actHint{ color:var(--muted); font-size:12px; }
    .chips{ display:flex; gap:8px; flex-wrap:wrap; }
    .chipBtn{
      border:1px solid var(--line);
      background:var(--chip);
      padding:8px 10px;
      border-radius:999px;
      font-size:13px;
      cursor:pointer;
      user-select:none;
    }
    .chipBtn.on{
      background:var(--chip2);
      border-color:rgba(59,130,246,.35);
      outline:3px solid rgba(59,130,246,.14);
    }

    .status{ color:var(--muted); font-size:13px; margin:0; line-height:1.45; }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 900px){ .grid{ grid-template-columns:1fr; } }

    .stepCard{
      border:1px solid var(--line);
      background:#fff;
      border-radius:16px;
      padding:12px;
      display:grid;
      gap:10px;
    }
    .stepTop{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
    .stepTitle{
      margin:0; font-size:14px; letter-spacing:.1px;
      display:flex; align-items:center; gap:8px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--chip);
      font-size:12px;
      color:rgba(17,24,39,.85);
      width:max-content;
    }
    .badge.type{ background:var(--chip2); }

    .place{ margin:0; font-size:16px; font-weight:950; letter-spacing:.1px; }
    .note{ margin:0; color:var(--muted); font-size:13px; line-height:1.45; min-height:2.6em; }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; }
    .small{ padding:9px 10px; border-radius:12px; font-size:13px; font-weight:850; }

    .actLine{
      border:1px dashed rgba(17,24,39,.22);
      background:rgba(59,130,246,.06);
      padding:10px 12px;
      border-radius:14px;
      font-size:13px;
      color:rgba(17,24,39,.88);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>ğŸ² ì¸ì²œ ì‚¬ìš´ë“œ ì½”ìŠ¤ ë£°ë ›</h1>
        <p class="sub">â€œë°¥/ì»¤í”¼ â†’ ìŒì•… ìŠ¤íŒŸ â†’ ì• í”„í„°â€ ìë™ ì¡°í•© + ë‚´ê°€ ì›í•˜ëŠ” Activityë¡œ í”Œë ˆì´.</p>
      </div>
      <p class="sub">GitHub Pages 1íŒŒì¼ ë²„ì „</p>
    </header>

    <section class="card">
      <div class="topbar">
        <div class="stamp">âœï¸ <b>Incheon Local Music Guide</b> <span style="color:var(--muted)">Course + Activities</span></div>
      </div>

      <div class="content">
        <div class="controls">
          <div class="row">
            <div class="field">
              <label>Area (ì„ íƒ)</label>
              <select id="area"></select>
            </div>
            <div class="field">
              <label>How many activities?</label>
              <select id="actLimit">
                <option value="1">1ê°œë§Œ</option>
                <option value="2">2ê°œ</option>
                <option value="3" selected>3ê°œ</option>
              </select>
            </div>
          </div>

          <div class="activityBox">
            <div class="actTop">
              <b>í•˜ê³  ì‹¶ì€ Activityë¥¼ ì„ íƒ (ìµœëŒ€ <span id="limitLabel">3</span>ê°œ)</b>
              <span class="actHint">ì„ íƒ ì•ˆ í•˜ë©´: ê·¸ëƒ¥ ëœë¤ ì½”ìŠ¤</span>
            </div>
            <div class="chips" id="actChips"></div>
            <div class="actions">
              <button id="clearActs" class="ghost" type="button">í™œë™ ì„ íƒ ì§€ìš°ê¸°</button>
              <button id="randomActs" class="ghost" type="button">ëœë¤ìœ¼ë¡œ ì„ íƒ</button>
            </div>
          </div>

          <div class="actions">
            <button id="spin" class="primary" type="button">Spin ì½”ìŠ¤ ë§Œë“¤ê¸°</button>
            <button id="copyCourse" class="ghost" type="button">ì½”ìŠ¤ í…ìŠ¤íŠ¸ ë³µì‚¬</button>
            <button id="reset" class="danger" type="button">Reset</button>
          </div>

          <p class="status" id="status">Activityë¥¼ ê³ ë¥´ê³  Spinì„ ëˆŒëŸ¬ë´.</p>
        </div>

        <div class="grid">
          <div class="stepCard">
            <div class="stepTop">
              <h2 class="stepTitle">ğŸš Step 1 Â· Warm-up</h2>
              <span class="badge type" id="warmType">â€”</span>
            </div>
            <p class="place" id="warmName">â€”</p>
            <div class="chips" id="warmChips"></div>
            <div class="actLine" id="warmAct">Activity: â€”</div>
            <p class="note" id="warmNote">â€”</p>
            <div class="actions">
              <button class="small primary" id="warmMap">ë„¤ì´ë²„ì§€ë„</button>
              <button class="small ghost" id="warmReroll">ì´ ë‹¨ê³„ë§Œ ë‹¤ì‹œ</button>
            </div>
          </div>

          <div class="stepCard">
            <div class="stepTop">
              <h2 class="stepTitle">ğŸ§ Step 2 Â· Main</h2>
              <span class="badge type" id="mainType">â€”</span>
            </div>
            <p class="place" id="mainName">â€”</p>
            <div class="chips" id="mainChips"></div>
            <div class="actLine" id="mainAct">Activity: â€”</div>
            <p class="note" id="mainNote">â€”</p>
            <div class="actions">
              <button class="small primary" id="mainMap">ë„¤ì´ë²„ì§€ë„</button>
              <button class="small ghost" id="mainReroll">ì´ ë‹¨ê³„ë§Œ ë‹¤ì‹œ</button>
            </div>
          </div>

          <div class="stepCard">
            <div class="stepTop">
              <h2 class="stepTitle">ğŸŒ™ Step 3 Â· After</h2>
              <span class="badge type" id="afterType">â€”</span>
            </div>
            <p class="place" id="afterName">â€”</p>
            <div class="chips" id="afterChips"></div>
            <div class="actLine" id="afterAct">Activity: â€”</div>
            <p class="note" id="afterNote">â€”</p>
            <div class="actions">
              <button class="small primary" id="afterMap">ë„¤ì´ë²„ì§€ë„</button>
              <button class="small ghost" id="afterReroll">ì´ ë‹¨ê³„ë§Œ ë‹¤ì‹œ</button>
            </div>
          </div>
        </div>

        <p class="status">
          â€» ê° ìŠ¤íŒŸì— <code>activities</code>ê°€ ë“¤ì–´ê°€ì•¼ â€œì„ íƒí•œ í™œë™â€ê³¼ ë§¤ì¹­í•´ì„œ ì¶”ì²œí•  ìˆ˜ ìˆì–´ìš”.
        </p>
      </div>
    </section>
  </div>

<script>
/**
 * 1) í™œë™(í‚¤ì›Œë“œ) ì‚¬ì „: id + label(í‘œì‹œ í…ìŠ¤íŠ¸)
 * 2) ê° ìŠ¤íŒŸì— activities: ["pick-record","write-1line"...] ê°™ì´ idë¥¼ ë„£ê¸°
 */
const ACTIVITIES = [
  { id:"pick-record",   label:"ğŸµ ë ˆì½”ë“œ/ìŒì•… í•œ ì¥ ê³ ë¥´ê¸°" },
  { id:"listen-1song",  label:"ğŸ§ í•œ ê³¡ ì§‘ì¤‘ ë“£ê¸°" },
  { id:"ask-reco",      label:"ğŸ—£ï¸ ì‚¬ì¥ë‹˜/ìŠ¤íƒœí”„ ì¶”ì²œ ë°›ê¸°" },
  { id:"write-1line",   label:"âœï¸ í•œ ì¤„ ë©”ëª¨(ê°€ì‚¬/ëŠë‚Œ)" },
  { id:"photo-cover",   label:"ğŸ“¸ ì»¤ë²„/ê°„íŒ ì‚¬ì§„ 1ì¥" },
  { id:"coffee-slow",   label:"â˜• ì»¤í”¼ ì²œì²œíˆ ë§ˆì‹œê¸°" },
  { id:"walk-15",       label:"ğŸš¶ 15ë¶„ ì‚°ì±…í•˜ê¸°" },
  { id:"send-to-friend",label:"ğŸ’¬ ì¹œêµ¬ì—ê²Œ ì¶”ì²œ í•œ ì¤„" },
  { id:"sticker-stamp", label:"ğŸ§¾ í‹°ì¼“/ìŠ¤í‹°ì»¤/ì˜ìˆ˜ì¦ ëª¨ìœ¼ê¸°" },
];

/**
 * âœ… ìŠ¤íŒŸ ë°ì´í„°: typeë¡œ Step ë¶„ë¥˜, activitiesë¡œ í–‰ë™ ë§¤ì¹­
 * type ì¶”ì²œ:
 * warm: "ë°¥" | "ì»¤í”¼"
 * main: "LPë°”" | "ë ˆì½”ë“œìƒµ" | "ë¼ì´ë¸Œ" | "ìŒì•…ê³µê°„"
 * after:"ì‚°ì±…" | "ì•¼ê²½" | "ë””ì €íŠ¸" | "ìˆ "
 */
const SPOTS = [
  // Warm-up
  { id:"w1", name:"ì˜ˆì‹œ) ë¶€í‰ êµ­ë°¥ì§‘", area:"ë¶€í‰", type:"ë°¥", tags:["ë“ ë“ ","ì ì‹¬"], note:"ë”°ëœ»í•˜ê²Œ ì‹œì‘.", naverMapUrl:"https://naver.me/REPLACE",
    activities:["write-1line","send-to-friend"] },
  { id:"w2", name:"ì˜ˆì‹œ) ë°°ë‹¤ë¦¬ ì»¤í”¼", area:"ë°°ë‹¤ë¦¬", type:"ì»¤í”¼", tags:["ì»¤í”¼","ì‚°ì±…"], note:"ì²« ì”ìœ¼ë¡œ í…œí¬ ì„¸íŒ….", naverMapUrl:"https://naver.me/REPLACE",
    activities:["coffee-slow","write-1line","photo-cover"] },

  // Main
  { id:"m1", name:"ì˜ˆì‹œ) íƒ„íŠ¸ë¼", area:"ë™ì¸ì²œ", type:"LPë°”", tags:["LP","ë°¤"], note:"ì¢‹ì€ ì†Œë¦¬ë¡œ ë©”ì¸ ì‹œì‘.", naverMapUrl:"https://naver.me/REPLACE",
    activities:["listen-1song","pick-record","write-1line"] },
  { id:"m2", name:"ì˜ˆì‹œ) í˜•ì œë ˆì½”ë“œ", area:"ë™ì¸ì²œ", type:"ë ˆì½”ë“œìƒµ", tags:["digging","ìˆ˜ì§‘"], note:"í•œ ì¥ ê³ ë¥´ë©´ í•˜ë£¨ê°€ ì •ë¦¬ë¨.", naverMapUrl:"https://naver.me/REPLACE",
    activities:["pick-record","ask-reco","photo-cover"] },
  { id:"m3", name:"ì˜ˆì‹œ) ë¼ì´ë¸Œ ê³µê°„", area:"ë¶€í‰", type:"ë¼ì´ë¸Œ", tags:["ê³µì—°","í˜„ì¥"], note:"ì˜¤ëŠ˜ì˜ ì‚¬ìš´ë“œë¥¼ ëª¸ìœ¼ë¡œ.", naverMapUrl:"https://naver.me/REPLACE",
    activities:["listen-1song","write-1line","sticker-stamp"] },

  // After
  { id:"a1", name:"ì˜ˆì‹œ) ë°”ë‹·ë°”ëŒ ì‚°ì±…", area:"ì›”ë¯¸/ë°”ë‹¤", type:"ì‚°ì±…", tags:["ê±·ê¸°","ë°”ëŒ"], note:"ê·€ë¥¼ ì‹íˆëŠ” ì‹œê°„.", naverMapUrl:"https://naver.me/REPLACE",
    activities:["walk-15","write-1line","photo-cover"] },
  { id:"a2", name:"ì˜ˆì‹œ) ë””ì €íŠ¸ ê°€ê²Œ", area:"ë°°ë‹¤ë¦¬", type:"ë””ì €íŠ¸", tags:["ë‹¬ë‹¬","ë§ˆë¬´ë¦¬"], note:"ì—”ë”© í¬ë ˆë”§ í•œ ì….", naverMapUrl:"https://naver.me/REPLACE",
    activities:["coffee-slow","send-to-friend","photo-cover"] },
  { id:"a3", name:"ì˜ˆì‹œ) ì‘ì€ ë°”", area:"ë™ì¸ì²œ", type:"ìˆ ", tags:["í•œì”","ë°¤"], note:"ì˜¤ëŠ˜ ë“¤ì€ ìŒì•… ì–˜ê¸°.", naverMapUrl:"https://naver.me/REPLACE",
    activities:["ask-reco","write-1line","send-to-friend"] },
];

// ===== DOM =====
const areaEl = document.getElementById("area");
const actLimitEl = document.getElementById("actLimit");
const limitLabel = document.getElementById("limitLabel");
const actChipsEl = document.getElementById("actChips");
const clearActsBtn = document.getElementById("clearActs");
const randomActsBtn = document.getElementById("randomActs");

const spinBtn = document.getElementById("spin");
const copyBtn = document.getElementById("copyCourse");
const resetBtn = document.getElementById("reset");
const statusEl = document.getElementById("status");

const warmTypeEl = document.getElementById("warmType");
const warmNameEl = document.getElementById("warmName");
const warmChipsEl = document.getElementById("warmChips");
const warmActEl  = document.getElementById("warmAct");
const warmNoteEl = document.getElementById("warmNote");
const warmMapBtn = document.getElementById("warmMap");
const warmRerollBtn = document.getElementById("warmReroll");

const mainTypeEl = document.getElementById("mainType");
const mainNameEl = document.getElementById("mainName");
const mainChipsEl = document.getElementById("mainChips");
const mainActEl  = document.getElementById("mainAct");
const mainNoteEl = document.getElementById("mainNote");
const mainMapBtn = document.getElementById("mainMap");
const mainRerollBtn = document.getElementById("mainReroll");

const afterTypeEl = document.getElementById("afterType");
const afterNameEl = document.getElementById("afterName");
const afterChipsEl = document.getElementById("afterChips");
const afterActEl  = document.getElementById("afterAct");
const afterNoteEl = document.getElementById("afterNote");
const afterMapBtn = document.getElementById("afterMap");
const afterRerollBtn = document.getElementById("afterReroll");

// ===== Utils =====
const uniq = (arr) => [...new Set(arr)];
const pickRandom = (arr) => arr[(Math.random() * arr.length) | 0];

function safeOpen(url){
  if(url && url.startsWith("http")) window.open(url, "_blank", "noopener,noreferrer");
  else alert("naverMapUrlì´ ë¹„ì–´ìˆì–´ìš”. SPOTS ë°ì´í„°ì— ë„¤ì´ë²„ì§€ë„ ë§í¬ë¥¼ ë„£ì–´ì¤˜!");
}

function renderBadgeChips(el, spot){
  el.innerHTML = "";
  const chips = [];
  if(spot.area) chips.push(`ğŸ“ ${spot.area}`);
  (spot.tags || []).slice(0,4).forEach(t => chips.push(`#${t}`));
  chips.forEach(t => {
    const s = document.createElement("span");
    s.className = "badge";
    s.textContent = t;
    el.appendChild(s);
  });
}

function actLabel(id){
  return (ACTIVITIES.find(a => a.id === id)?.label) || id;
}

function intersectCount(aIds, bIds){
  if(!aIds?.length || !bIds?.length) return 0;
  const setB = new Set(bIds);
  let c = 0;
  for(const x of aIds) if(setB.has(x)) c++;
  return c;
}

function pickActivityForSpot(spot, selectedActs){
  const spotActs = spot.activities || [];
  if(spotActs.length === 0) return null;

  if(selectedActs.size > 0){
    const inter = spotActs.filter(id => selectedActs.has(id));
    if(inter.length) return pickRandom(inter);
  }
  return pickRandom(spotActs);
}

// ===== Activity selection UI =====
let selectedActs = new Set();

function renderActChips(){
  actChipsEl.innerHTML = "";
  for(const a of ACTIVITIES){
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "chipBtn" + (selectedActs.has(a.id) ? " on" : "");
    btn.textContent = a.label;
    btn.addEventListener("click", () => toggleAct(a.id));
    actChipsEl.appendChild(btn);
  }
}

function toggleAct(id){
  const limit = Number(actLimitEl.value || 3);
  if(selectedActs.has(id)){
    selectedActs.delete(id);
    statusEl.textContent = `Activity ì„ íƒ: ${selectedActs.size}/${limit}`;
  }else{
    if(selectedActs.size >= limit){
      statusEl.textContent = `ìµœëŒ€ ${limit}ê°œê¹Œì§€ ì„ íƒ ê°€ëŠ¥! (ì§€ê¸ˆ ${selectedActs.size}ê°œ)`;
      return;
    }
    selectedActs.add(id);
    statusEl.textContent = `Activity ì„ íƒ: ${selectedActs.size}/${limit}`;
  }
  renderActChips();
}

function clearActs(){
  selectedActs = new Set();
  statusEl.textContent = "Activity ì„ íƒì„ ì§€ì› ì–´. (ì™„ì „ ëœë¤ ê°€ëŠ¥)";
  renderActChips();
}

function randomActs(){
  clearActs();
  const limit = Number(actLimitEl.value || 3);
  const ids = ACTIVITIES.map(a=>a.id);
  // shuffle-ish
  for(let i=ids.length-1;i>0;i--){
    const j = (Math.random()*(i+1))|0;
    [ids[i],ids[j]]=[ids[j],ids[i]];
  }
  ids.slice(0,limit).forEach(id=>selectedActs.add(id));
  statusEl.textContent = `ëœë¤ ì„ íƒ ì™„ë£Œ: ${selectedActs.size}/${limit}`;
  renderActChips();
}

// ===== Area options =====
function buildAreaOptions(){
  const areas = uniq(SPOTS.map(s=>s.area).filter(Boolean)).sort((a,b)=>a.localeCompare(b,'ko'));
  areaEl.innerHTML = `<option value="">All areas</option>` + areas.map(a=>`<option value="${a}">${a}</option>`).join("");
}

// ===== Step pools =====
function getPoolByStep(step){
  const area = areaEl.value;
  const base = area ? SPOTS.filter(s => s.area === area) : SPOTS.slice();

  const warmTypes = new Set(["ë°¥","ì»¤í”¼"]);
  const mainTypes = new Set(["LPë°”","ë ˆì½”ë“œìƒµ","ë¼ì´ë¸Œ","ìŒì•…ê³µê°„"]);
  const afterTypes = new Set(["ì‚°ì±…","ì•¼ê²½","ë””ì €íŠ¸","ìˆ "]);

  if(step === "warm")  return base.filter(s => warmTypes.has(s.type));
  if(step === "main")  return base.filter(s => mainTypes.has(s.type));
  if(step === "after") return base.filter(s => afterTypes.has(s.type));
  return [];
}

function pickSpot(step, usedIds){
  const pool0 = getPoolByStep(step).filter(s => !usedIds.has(s.id));
  const pool = pool0.length ? pool0 : getPoolByStep(step); // fallback allow duplicates if needed
  if(pool.length === 0) return null;

  // activity-based scoring: selectedActsì™€ ê²¹ì¹ ìˆ˜ë¡ ìš°ì„ 
  const sel = [...selectedActs];
  if(sel.length === 0) return pickRandom(pool);

  const scored = pool.map(s => ({ s, score: intersectCount(sel, s.activities || []) }));
  const max = Math.max(...scored.map(x=>x.score));
  const best = scored.filter(x => x.score === max).map(x=>x.s);

  // max==0ì´ë©´ ê²°êµ­ ëœë¤(ì„ íƒí™œë™ì´ ìŠ¤íŒŸì— ì—†ì„ ë•Œ)
  return pickRandom(best);
}

// ===== Render cards =====
function setCard(step, spot){
  const act = spot ? pickActivityForSpot(spot, selectedActs) : null;
  const actText = act ? actLabel(act) : "â€”";

  if(step === "warm"){
    warmTypeEl.textContent = spot ? spot.type : "â€”";
    warmNameEl.textContent = spot ? spot.name : "â€”";
    warmNoteEl.textContent = spot ? (spot.note || "") : "â€”";
    renderBadgeChips(warmChipsEl, spot || {});
    warmActEl.textContent = `Activity: ${actText}`;
    warmMapBtn.onclick = () => safeOpen(spot?.naverMapUrl);
  }
  if(step === "main"){
    mainTypeEl.textContent = spot ? spot.type : "â€”";
    mainNameEl.textContent = spot ? spot.name : "â€”";
    mainNoteEl.textContent = spot ? (spot.note || "") : "â€”";
    renderBadgeChips(mainChipsEl, spot || {});
    mainActEl.textContent = `Activity: ${actText}`;
    mainMapBtn.onclick = () => safeOpen(spot?.naverMapUrl);
  }
  if(step === "after"){
    afterTypeEl.textContent = spot ? spot.type : "â€”";
    afterNameEl.textContent = spot ? spot.name : "â€”";
    afterNoteEl.textContent = spot ? (spot.note || "") : "â€”";
    renderBadgeChips(afterChipsEl, spot || {});
    afterActEl.textContent = `Activity: ${actText}`;
    afterMapBtn.onclick = () => safeOpen(spot?.naverMapUrl);
  }
}

let current = { warm:null, main:null, after:null };

function spinAll(){
  const used = new Set();
  const warm = pickSpot("warm", used); if(warm) used.add(warm.id);
  const main = pickSpot("main", used); if(main) used.add(main.id);
  const after = pickSpot("after", used); if(after) used.add(after.id);

  current = { warm, main, after };
  setCard("warm", warm);
  setCard("main", main);
  setCard("after", after);

  const areaTxt = areaEl.value ? `(${areaEl.value}) ` : "";
  const lim = Number(actLimitEl.value || 3);
  statusEl.textContent = `ì½”ìŠ¤ ìƒì„± ì™„ë£Œ ${areaTxt}â€” Activity ${selectedActs.size}/${lim} ë°˜ì˜ë¨.`;
}

function reroll(step){
  const used = new Set(["warm","main","after"].filter(k=>k!==step).map(k=>current[k]?.id).filter(Boolean));
  const picked = pickSpot(step, used);
  current[step] = picked;
  setCard(step, picked);
  statusEl.textContent = "í•œ ë‹¨ê³„ ë‹¤ì‹œ ë½‘ì•˜ì–´.";
}

function courseText(){
  const wantActs = [...selectedActs].map(actLabel);
  const wants = wantActs.length ? `\nğŸ¯ Want to do: ${wantActs.join(" / ")}` : "";
  const w = current.warm ? `1) Warm-up: ${current.warm.name}` : "1) Warm-up: â€”";
  const m = current.main ? `2) Main: ${current.main.name}` : "2) Main: â€”";
  const a = current.after ? `3) After: ${current.after.name}` : "3) After: â€”";
  return `ğŸ² ì¸ì²œ ì‚¬ìš´ë“œ ì½”ìŠ¤ ë£°ë ›\n${w}\n${m}\n${a}${wants}`;
}

async function copyCourse(){
  const text = courseText();
  try{
    await navigator.clipboard.writeText(text);
    statusEl.textContent = "ì½”ìŠ¤ í…ìŠ¤íŠ¸ ë³µì‚¬ ì™„ë£Œ!";
  }catch{
    prompt("ë³µì‚¬ê°€ ë§‰í˜€ìˆìœ¼ë©´ ì—¬ê¸°ì„œ ë³µì‚¬:", text);
  }
}

function resetUI(){
  current = { warm:null, main:null, after:null };
  setCard("warm", null);
  setCard("main", null);
  setCard("after", null);
  statusEl.textContent = "Activityë¥¼ ê³ ë¥´ê³  Spinì„ ëˆŒëŸ¬ë´.";
}

// ===== Wire up =====
document.getElementById("spin").addEventListener("click", spinAll);
document.getElementById("copyCourse").addEventListener("click", copyCourse);
document.getElementById("reset").addEventListener("click", resetUI);

warmRerollBtn.addEventListener("click", () => reroll("warm"));
mainRerollBtn.addEventListener("click", () => reroll("main"));
afterRerollBtn.addEventListener("click", () => reroll("after"));

actLimitEl.addEventListener("change", () => {
  const limit = Number(actLimitEl.value || 3);
  limitLabel.textContent = String(limit);
  // limit ì¤„ì˜€ì„ ë•Œ ì´ˆê³¼ë¶„ ìë™ ì •ë¦¬
  while(selectedActs.size > limit){
    selectedActs.delete([...selectedActs][selectedActs.size-1]);
  }
  renderActChips();
  statusEl.textContent = `ìµœëŒ€ ì„ íƒ ìˆ˜ ë³€ê²½: ${selectedActs.size}/${limit}`;
});

clearActsBtn.addEventListener("click", clearActs);
randomActsBtn.addEventListener("click", randomActs);

// ===== Init =====
buildAreaOptions();
limitLabel.textContent = actLimitEl.value;
renderActChips();
resetUI();
</script>
</body>
</html>
